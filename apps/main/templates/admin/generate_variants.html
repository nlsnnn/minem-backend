{% extends "admin/base_site.html" %} 
{% block extrastyle %}
<style>
  .variant-generator {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .info-box {
    background: #e8f4f8;
    border-left: 4px solid #417690;
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 4px;
  }

  .info-box h3 {
    margin-top: 0;
    color: #417690;
  }

  .info-box ul {
    margin: 10px 0;
    padding-left: 20px;
  }

  .form-section {
    background: white;
    border: 1px solid #ddd;
    padding: 25px;
    margin-bottom: 20px;
    border-radius: 4px;
  }

  .form-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
    font-size: 16px;
    border-bottom: 2px solid #417690;
    padding-bottom: 10px;
  }

  .options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .option-group {
    border: 1px solid #e0e0e0;
    padding: 12px;
    border-radius: 4px;
    background: #fafafa;
  }

  .option-group-title {
    font-weight: bold;
    color: #417690;
    margin-bottom: 8px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .select-all-btn {
    font-size: 11px;
    color: #417690;
    cursor: pointer;
    text-decoration: underline;
    font-weight: normal;
  }

  .select-all-btn:hover {
    color: #2e5a6e;
  }

  .option-group label {
    display: block;
    margin: 5px 0;
    font-weight: normal;
  }

  .option-group input[type="checkbox"] {
    margin-right: 8px;
  }

  .form-row {
    margin-bottom: 20px;
  }

  .form-row label {
    display: block;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
  }

  .form-row input[type="number"],
  .form-row input[type="text"] {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    width: 300px;
    max-width: 100%;
  }

  .form-row .helptext {
    display: block;
    color: #666;
    font-size: 13px;
    margin-top: 5px;
  }

  .checkbox-row {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .checkbox-row input[type="checkbox"] {
    margin-right: 8px;
  }

  .checkbox-row label {
    font-weight: bold;
    margin: 0;
  }

  .submit-row {
    background: #f8f8f8;
    padding: 15px 25px;
    border-top: 1px solid #ddd;
    margin-top: 20px;
  }

  .submit-row input[type="submit"] {
    background: #417690;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }

  .submit-row input[type="submit"]:hover {
    background: #2e5a6e;
  }

  .submit-row .cancel {
    background: #999;
    color: white;
    padding: 12px 30px;
    text-decoration: none;
    border-radius: 4px;
    margin-left: 10px;
    display: inline-block;
  }

  .submit-row .cancel:hover {
    background: #777;
  }

  .errorlist {
    background: #ffebe8;
    border-left: 4px solid #ba2121;
    padding: 10px;
    margin-bottom: 15px;
    list-style: none;
    color: #ba2121;
  }

  .example-box {
    background: #fff9e6;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin-top: 15px;
    border-radius: 4px;
  }

  .example-box strong {
    color: #ff8f00;
  }
</style>
{% endblock %}

{% block content %}
<div class="variant-generator">
  <h1>{{ title }}</h1>

  <div class="info-box">
    <h3>üì¶ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?</h3>
    <ul>
      <li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–ø—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö—Ä–∞—Å–Ω—ã–π, –°–∏–Ω–∏–π –∏–∑ "–¶–≤–µ—Ç"; S, M, L –∏–∑ "–†–∞–∑–º–µ—Ä")</li>
      <li>–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</li>
      <li>–ö–∞–∂–¥–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ü–µ–Ω–∞ –∏ –æ—Å—Ç–∞—Ç–æ–∫</li>
      <li>–ê—Ä—Ç–∏–∫—É–ª –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏ –æ–ø—Ü–∏–π</li>
    </ul>
  </div>

  <form method="post">
    {% csrf_token %}

    <div class="form-section">
      <h3>1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–ø—Ü–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
      
      {% if form.option_values.errors %}
      <ul class="errorlist">
        {% for error in form.option_values.errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <p class="helptext">{{ form.option_values.help_text }}</p>

      <div class="options-grid" id="options-grid">
        <!-- JavaScript –∑–∞–ø–æ–ª–Ω–∏—Ç –æ–ø—Ü–∏–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏, –ª–∏–±–æ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –æ–±—ã—á–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã -->
        <div id="fallback-options" style="padding: 10px;">
          {{ form.option_values }}
        </div>
      </div>

      <div class="example-box">
        <strong>–ü—Ä–∏–º–µ—Ä:</strong> –ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å "–ö—Ä–∞—Å–Ω—ã–π, –°–∏–Ω–∏–π" (–¶–≤–µ—Ç) –∏ "S, M, L" (–†–∞–∑–º–µ—Ä), 
        –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ 6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: –ö—Ä–∞—Å–Ω—ã–π-S, –ö—Ä–∞—Å–Ω—ã–π-M, –ö—Ä–∞—Å–Ω—ã–π-L, –°–∏–Ω–∏–π-S, –°–∏–Ω–∏–π-M, –°–∏–Ω–∏–π-L
      </div>
    </div>

    <div class="form-section">
      <h3>2Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</h3>

      <div class="form-row">
        {% if form.base_price.errors %}
        <ul class="errorlist">
          {% for error in form.base_price.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
        <label for="id_base_price">{{ form.base_price.label }}:</label>
        {{ form.base_price }}
        <span class="helptext">{{ form.base_price.help_text }}</span>
      </div>

      <div class="form-row">
        {% if form.stock.errors %}
        <ul class="errorlist">
          {% for error in form.stock.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
        <label for="id_stock">{{ form.stock.label }}:</label>
        {{ form.stock }}
        <span class="helptext">{{ form.stock.help_text }}</span>
      </div>

      <div class="checkbox-row">
        {{ form.is_active }}
        <label for="id_is_active">{{ form.is_active.label }}</label>
      </div>

      <div class="checkbox-row">
        {{ form.copy_product_media }}
        <label for="id_copy_product_media">{{ form.copy_product_media.label }}</label>
        <span class="helptext" style="margin-left: 8px;">{{ form.copy_product_media.help_text }}</span>
      </div>
    </div>

    <div class="submit-row">
      <input type="submit" value="‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã" class="default" />
      <a href="{% url 'admin:main_product_change' product.id %}" class="cancel">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fallbackContainer = document.getElementById('fallback-options');
    const grid = document.getElementById('options-grid');
    const checkboxes = fallbackContainer.querySelectorAll('input[type="checkbox"]');
    
    console.log('Found checkboxes:', checkboxes.length);
    
    if (checkboxes.length === 0) {
      grid.innerHTML = '<div style="padding: 20px; background: #fff3cd; border-radius: 4px;"><strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ü–∏–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–ø—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞"</div>';
      return;
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å—ã –ø–æ –æ–ø—Ü–∏—è–º
    const optionGroups = {};
    
    checkboxes.forEach(checkbox => {
      const label = checkbox.parentElement;
      if (!label) return;
      
      const text = label.textContent.trim();
      console.log('Processing checkbox label:', text);
      const match = text.match(/^(.+?)\s*-\s*(.+)$/);
      
      if (match) {
        const [, optionName, valueName] = match;
        
        if (!optionGroups[optionName]) {
          optionGroups[optionName] = [];
        }
        
        optionGroups[optionName].push({
          checkbox: checkbox,
          value: valueName,
          label: label
        });
      }
    });
    
    console.log('Option groups:', Object.keys(optionGroups));
    
    // –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (Object.keys(optionGroups).length === 0) {
      console.log('Could not parse options, keeping fallback');
      return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–µ –≥—Ä—É–ø–ø—ã
    const newGrid = document.createElement('div');
    newGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;';
    
    Object.keys(optionGroups).sort().forEach(optionName => {
      const group = document.createElement('div');
      group.className = 'option-group';
      
      const title = document.createElement('div');
      title.className = 'option-group-title';
      
      const titleText = document.createElement('span');
      titleText.textContent = optionName;
      title.appendChild(titleText);
      
      const selectAllBtn = document.createElement('span');
      selectAllBtn.className = 'select-all-btn';
      selectAllBtn.textContent = '–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ';
      selectAllBtn.onclick = function() {
        const groupCheckboxes = group.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(groupCheckboxes).every(cb => cb.checked);
        groupCheckboxes.forEach(cb => {
          cb.checked = !allChecked;
          const originalId = cb.getAttribute('data-original-id');
          if (originalId) {
            const original = document.getElementById(originalId);
            if (original) original.checked = cb.checked;
          }
          cb.dispatchEvent(new Event('change'));
        });
        selectAllBtn.textContent = allChecked ? '–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ' : '—Å–Ω—è—Ç—å –≤—Å–µ';
      };
      title.appendChild(selectAllBtn);
      
      group.appendChild(title);
      
      optionGroups[optionName].forEach(item => {
        const wrapper = document.createElement('label');
        const newCheckbox = item.checkbox.cloneNode(true);
        newCheckbox.setAttribute('data-original-id', item.checkbox.id);
        wrapper.appendChild(newCheckbox);
        wrapper.appendChild(document.createTextNode(' ' + item.value));
        group.appendChild(wrapper);
      });
      
      newGrid.appendChild(group);
    });
    
    grid.insertBefore(newGrid, fallbackContainer);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    fallbackContainer.style.display = 'none';
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const newCheckboxes = newGrid.querySelectorAll('input[type="checkbox"]');
    newCheckboxes.forEach((newCheckbox, index) => {
      const originalCheckbox = Array.from(checkboxes)[index];
      if (originalCheckbox) {
        newCheckbox.checked = originalCheckbox.checked;
        newCheckbox.addEventListener('change', function() {
          originalCheckbox.checked = this.checked;
          updateVariantCount();
        });
      }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å—á–µ—Ç–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    function updateVariantCount() {
      const selectedByOption = {};
      
      newCheckboxes.forEach((cb) => {
        if (cb.checked) {
          const label = cb.parentElement;
          const optionGroup = label.closest('.option-group');
          if (!optionGroup) return;
          
          const titleSpan = optionGroup.querySelector('.option-group-title span');
          if (!titleSpan) return;
          
          const optionName = titleSpan.textContent;
          
          if (!selectedByOption[optionName]) {
            selectedByOption[optionName] = 0;
          }
          selectedByOption[optionName]++;
        }
      });
      
      const optionNames = Object.keys(selectedByOption);
      let totalVariants = 0;
      let formula = '';
      
      if (optionNames.length > 0) {
        totalVariants = Object.values(selectedByOption).reduce((a, b) => a * b, 1);
        formula = Object.values(selectedByOption).join(' √ó ');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å—á–µ—Ç—á–∏–∫
      let counter = document.getElementById('variant-counter');
      if (!counter) {
        counter = document.createElement('div');
        counter.id = 'variant-counter';
        counter.style.cssText = 'background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 15px; border-radius: 4px; font-size: 16px;';
        const exampleBox = document.querySelector('.example-box');
        if (exampleBox) {
          exampleBox.parentNode.insertBefore(counter, exampleBox);
        }
      }
      
      if (totalVariants > 0) {
        counter.innerHTML = `
          <strong style="color: #ff8f00;">üìä –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:</strong> 
          <span style="font-size: 20px; font-weight: bold; color: #28a745;">${totalVariants}</span>
          ${formula ? `<span style="color: #666;"> (${formula})</span>` : ''}
        `;
        counter.style.display = 'block';
      } else {
        counter.style.display = 'none';
      }
    }
    
    // –ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç
    updateVariantCount();
  });
</script>
{% endblock %}
